@page "/Deposits"
@using BusinessLogic.DTOs
@using BusinessLogic.Services
@using UI.Data
@using UI.Pages.Components
@inherits AuthEnforce
@inject UserController User
@inject DepositService DepositService
@inject NotificationService NotificationService

@code {

    private DepositDto _depositDto = new()
    {
        Name = "",
        Area = "A",
        Size = "Small",
        ClimateControl = false,
        Promotions = new List<PromotionDto>()
    };

    private List<DepositDto> DepositsDto { get; set; } = new();

    protected override void OnAfterRender(bool firstRender)
    {
        DepositsDto = DepositService.GetAllDeposits().ToList();
        StateHasChanged();
    }

    private void AddDeposit()
    {
        if (string.IsNullOrEmpty(_depositDto.Name))
        {
            NotificationService.ShowError("Name of Deposit is required.");
            return;
        }

        try
        {
            DepositService.AddDeposit(_depositDto, User.CurrentCredentials);
            NotificationService.ShowMessage("Deposit added successfully.");
            StateHasChanged();
        }
        catch (ArgumentException e)
        {
            NotificationService.ShowError(e.Message);
        }
    }

}

<main class="responsive">
    <h6 class="vertical-margin">
        Deposits
        @if (User.IsAdmin)
        {
            <button class="extend square round no-margin absolute right" data-ui="#add-deposit">
                <i>add</i>
                <span>Add</span>
            </button>
            <div class="medium-space"></div>
        }
    </h6>
    <article>
        @foreach (var deposit in DepositsDto)
        {
            <a class="row padding surface-container wave scroll" href="/Deposit/@deposit.Name">
                <div class="row max">
                    <div class="button inverse-primary">@deposit.Name</div>
                </div>
                <div>
                    <h6 class="button small primary-container">Area: @deposit.Area</h6>
                    <h6 class="button small primary-container">Size: @deposit.Size</h6>

                    @if (deposit.ClimateControl)
                    {
                        <h6 class="button small primary-container">Climate Control</h6>
                    }
                </div>
            </a>
            <div class="divider right-align"></div>
        }
        @if (DepositsDto.Count == 0)
        {
            <p>No deposits found.</p>
        }
    </article>
</main>

@if (User.IsAdmin)
{
    <div class="medium-space"></div>
    <div class="overlay blur"></div>
    <dialog class="medium-width no-elevate" id="add-deposit">
        <div class="padding center-align">
            <i>garage_door</i>
            <h6 class="center-align">Add new deposit</h6>
        </div>
        <form @onsubmit="AddDeposit">
            <div class="field label prefix border left-align">
                <i>garage_door</i>
                <input type="text" @bind="_depositDto.Name" required>
                <label>Name of Deposit</label>
            </div>
            <div class="field label suffix border">
                <select @bind="_depositDto.Area">
                    <option>A</option>
                    <option>B</option>
                    <option>C</option>
                    <option>D</option>
                    <option>E</option>
                </select>
                <label>Area</label>
                <i>arrow_drop_down</i>
            </div>
            <div class="field label suffix border">
                <select @bind="_depositDto.Size">
                    <option>Small</option>
                    <option>Medium</option>
                    <option>Large</option>
                </select>
                <label>Size</label>
                <i>arrow_drop_down</i>
            </div>
            <PromotionSelect @bind-Promotions="_depositDto.Promotions"/>
            <div class="divider"></div>
            <div class="field no-margin top-padding">
                <label class="checkbox">
                    <input type="checkbox" @bind="_depositDto.ClimateControl">
                    <span>Climate Control</span>
                </label>
            </div>

            <nav class="right-align no-space no-margin">
                <button class="transparent link" data-ui="#add-deposit">Cancel</button>
                <button type="submit" class="transparent link">Confirm</button>
            </nav>
        </form>
    </dialog>
}